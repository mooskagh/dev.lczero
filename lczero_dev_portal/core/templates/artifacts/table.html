{% extends "core/base.html" %}

{% block title %}Build Artifacts{% endblock %}

{% block content %}
<h1>Build Artifacts</h1>

{% if can_manage %}
<div class="admin-controls">
    <form method="post" action="{% url 'artifacts:bulk_manage' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit">Save Changes</button>
    </form>
    <form method="post" action="{% url 'artifacts:run_janitor' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" onclick="return confirm('Run janitor task now? This will delete old artifacts according to retention policy.')">Run Janitor Now</button>
    </form>
</div>

<form method="post" action="{% url 'artifacts:bulk_manage' %}">
    {% csrf_token %}
{% endif %}

    <table>
        <thead>
            <tr>
                {% if can_manage %}<th>Admin</th>{% endif %}
                <th>Commit</th>
                <th>Date</th>
                <th>PR</th>
                <th>Tag</th>
                <th>Status</th>
                <th>Cleanup</th>
                {% for target in targets %}
                <th>{{ target.name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in matrix %}
            <tr class="revision-row {% if row.revision.is_pinned %}pinned{% endif %} {% if row.revision.is_scheduled_for_deletion %}scheduled{% endif %}">
                {% if can_manage %}
                <td class="admin-controls-cell">
                    <label class="minibutton" title="Hidden"><input type="checkbox" name="revision_{{ row.revision.id }}_hidden" {% if row.revision.is_hidden %}checked{% endif %}><span>H</span></label>
                    <label class="minibutton" title="Scheduled for deletion"><input type="checkbox" name="revision_{{ row.revision.id }}_deletion" {% if row.revision.is_scheduled_for_deletion %}checked{% endif %}><span>D</span></label>
                    <label class="minibutton" title="Pinned"><input type="checkbox" name="revision_{{ row.revision.id }}_pinned" {% if row.revision.is_pinned %}checked{% endif %}><span>P</span></label>
                </td>
                {% endif %}
                <td><code>{{ row.revision.commit_hash|slice:":8" }}</code></td>
                <td>{{ row.revision.datetime|date:"Y-m-d H:i:s" }}</td>
                <td>
                    {% if row.revision.pr_number %}
                        <a href="#" class="pr-link">#{{ row.revision.pr_number }}</a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="tag-cell">{{ row.revision.tag_description|default:"-" }}</td>
                <td class="status-cell">
                    {% if row.revision.is_pinned %}<span class="status-badge pinned">üìå</span>{% endif %}
                    {% if row.revision.is_scheduled_for_deletion %}<span class="status-badge scheduled">üóëÔ∏è</span>{% endif %}
                </td>
                <td class="cleanup-cell">
                    <span class="cleanup-status {% if row.revision.cleanup_status_display == 'today' %}urgent{% endif %}">
                        {{ row.revision.cleanup_status_display }}
                    </span>
                </td>
                {% for artifact in row.artifacts %}
                <td class="artifact-cell">
                    {% if artifact %}
                        <a href="{% url 'artifacts:download' artifact.id %}" class="artifact-link">
                            {{ artifact.filename }}
                            <span class="file-size">({{ artifact.size|filesizeformat }})</span>
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

{% if can_manage %}
</form>
{% endif %}

{% if not matrix %}
<div class="empty-state">
    <p>No build artifacts found.</p>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}{% endblock %}